# 二手交易应用 - 系统架构图

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户层 (User Layer)                        │
├─────────────────────────────────────────────────────────────────┤
│  📱 移动端用户  │  💻 桌面端用户  │  🌐 Web端用户                │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                     前端层 (Frontend Layer)                       │
├─────────────────────────────────────────────────────────────────┤
│  React + TypeScript + Vite                                       │
│  ├── 移动端适配 (Antd Mobile)                                    │
│  ├── 响应式设计 (CSS Grid/Flexbox)                              │
│  ├── 状态管理 (React Hooks)                                     │
│  └── 路由管理 (React Router)                                    │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                     网络层 (Network Layer)                        │
├─────────────────────────────────────────────────────────────────┤
│  HTTPS/SSL  │  RESTful API  │  Axios HTTP Client               │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                     后端层 (Backend Layer)                        │
├─────────────────────────────────────────────────────────────────┤
│  Node.js + Express.js + MongoDB                                 │
│  ├── 用户认证 (JWT + bcrypt)                                    │
│  ├── 文件上传 (Multer)                                          │
│  ├── 数据验证 (Express Validator)                               │
│  └── 中间件 (CORS, Auth, Rate Limiting)                        │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                     数据层 (Data Layer)                           │
├─────────────────────────────────────────────────────────────────┤
│  MongoDB Atlas (云数据库)                                        │
│  ├── 用户集合 (Users)                                           │
│  ├── 商品集合 (Products)                                        │
│  ├── 聊天集合 (Chats)                                           │
│  ├── 消息集合 (Messages)                                        │
│  ├── 评价集合 (Ratings)                                         │
│  └── 举报集合 (Reports)                                         │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                     服务层 (Service Layer)                        │
├─────────────────────────────────────────────────────────────────┤
│  AI服务集成                                                      │
│  ├── OpenAI API (内容审核)                                      │
│  ├── Hugging Face (价格估算)                                    │
│  ├── 短信服务 (SMS)                                             │
│  ├── 验证码服务 (Captcha)                                       │
│  └── 地理位置服务 (Geo)                                         │
└─────────────────────────────────────────────────────────────────┘
```

## 📱 前端架构详细图

```
┌─────────────────────────────────────────────────────────────────┐
│                       前端应用架构 (Frontend Architecture)          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │
│  │   页面组件      │    │   业务组件      │    │   通用组件      │ │
│  │  (Pages)        │    │  (Features)     │    │  (Common)       │ │
│  ├─────────────────┤    ├─────────────────┤    ├─────────────────┤ │
│  │ • MobileHome    │    │ • ProductForm   │    │ • Button        │ │
│  │ • Login         │    │ • ChatWindow    │    │ • Input         │ │
│  │ • Register      │    │ • UserProfile   │    │ • MapDisplay    │ │
│  │ • MessageList   │    │ • ProductList   │    │ • Header        │ │
│  │ • ChatWindow    │    │ • ProductCard   │    │ • Footer        │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘ │
│           │                       │                       │         │
│           └───────────────────────┼───────────────────────┘         │
│                                   │                                 │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                   状态管理 (State Management)                    │ │
│  ├─────────────────────────────────────────────────────────────────┤ │
│  │ • React Hooks (useState, useEffect, useContext)                │ │
│  │ • Local Storage (用户登录状态、购物车)                          │ │
│  │ • URL State (路由参数)                                         │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                   │                                 │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                   路由管理 (Routing)                            │ │
│  ├─────────────────────────────────────────────────────────────────┤ │
│  │ • React Router v6                                              │ │
│  │ • 嵌套路由 (Nested Routes)                                     │ │
│  │ • 路由守卫 (Route Guards)                                      │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                   │                                 │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                   样式系统 (Styling)                            │ │
│  ├─────────────────────────────────────────────────────────────────┤ │
│  │ • CSS Modules                                                  │ │
│  │ • Emotion Styled Components                                   │ │
│  │ • Antd Mobile UI Components                                   │ │
│  │ • 响应式设计 (Mobile First)                                    │ │
│  └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 🔧 后端架构详细图

```
┌─────────────────────────────────────────────────────────────────┐
│                       后端应用架构 (Backend Architecture)          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │
│  │   路由层        │    │   控制器层      │    │   服务层        │ │
│  │  (Routes)       │    │  (Controllers)  │    │  (Services)     │ │
│  ├─────────────────┤    ├─────────────────┤    ├─────────────────┤ │
│  │ • userRoutes    │    │ • UserController│    │ • AuthService   │ │
│  │ • productRoutes │    │ • ProductCtrl   │    │ • UploadService │ │
│  │ • chatRoutes    │    │ • ChatController│    │ • AIService     │ │
│  │ • ratingRoutes  │    │ • RatingCtrl    │    │ • SMSService    │ │
│  │ • reportRoutes  │    │ • ReportCtrl    │    │ • GeoService    │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘ │
│           │                       │                       │         │
│           └───────────────────────┼───────────────────────┘         │
│                                   │                                 │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                   中间件层 (Middleware)                          │ │
│  ├─────────────────────────────────────────────────────────────────┤ │
│  │ • 认证中间件 (JWT Auth)                                        │ │
│  │ • 错误处理中间件 (Error Handler)                                │ │
│  │ • 日志中间件 (Logging)                                         │ │
│  │ • CORS中间件 (跨域处理)                                        │ │
│  │ • 限流中间件 (Rate Limiting)                                   │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                   │                                 │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                   数据访问层 (Data Access)                       │ │
│  ├─────────────────────────────────────────────────────────────────┤ │
│  │ • Mongoose ODM                                                 │ │
│  │ • 数据模型 (Models)                                            │ │
│  │ • 数据库连接池                                                 │ │
│  │ • 查询优化                                                     │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                   │                                 │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                   工具层 (Utils)                                │ │
│  ├─────────────────────────────────────────────────────────────────┤ │
│  │ • AI内容审核                                                   │ │
│  │ • 价格估算算法                                                 │ │
│  │ • 文件上传处理                                                 │ │
│  │ • 短信发送服务                                                 │ │
│  │ • 地理位置服务                                                 │ │
│  └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 🗄️ 数据库设计图

```
┌─────────────────────────────────────────────────────────────────┐
│                       数据库架构 (Database Schema)                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │
│  │   用户集合      │    │   商品集合      │    │   聊天集合      │ │
│  │  (Users)        │    │  (Products)     │    │  (Chats)        │ │
│  ├─────────────────┤    ├─────────────────┤    ├─────────────────┤ │
│  │ • _id           │    │ • _id           │    │ • _id           │ │
│  │ • username      │    │ • title         │    │ • participants  │ │
│  │ • passwordHash  │    │ • description   │    │ • createdAt     │ │
│  │ • email         │    │ • price         │    │ • updatedAt     │ │
│  │ • phone         │    │ • category      │    │ • lastMessage   │ │
│  │ • location      │    │ • images        │    │ • unreadCount   │ │
│  │ • avatar        │    │ • seller        │    └─────────────────┘ │
│  │ • createdAt     │    │ • status        │                       │
│  │ • updatedAt     │    │ • createdAt     │    ┌─────────────────┐ │
│  └─────────────────┘    │ • updatedAt     │    │   消息集合      │ │
│           │             └─────────────────┘    │  (Messages)     │ │
│           │                       │            ├─────────────────┤ │
│           │                       │            │ • _id           │ │
│           │                       │            │ • chatId        │ │
│           │                       │            │ • sender        │ │
│           │                       │            │ • content       │ │
│           │                       │            │ • type          │ │
│           │                       │            │ • createdAt     │ │
│           │                       │            └─────────────────┘ │
│           │                       │                                 │
│           │                       │            ┌─────────────────┐ │
│           │                       │            │   评价集合      │ │
│           │                       │            │  (Ratings)      │ │
│           │                       │            ├─────────────────┤ │
│           │                       │            │ • _id           │ │
│           │                       │            │ • productId     │ │
│           │                       │            │ • reviewer      │ │
│           │                       │            │ • rating        │ │
│           │                       │            │ • comment       │ │
│           │                       │            │ • createdAt     │ │
│           │                       │            └─────────────────┘ │
│           │                       │                                 │
│           │                       │            ┌─────────────────┐ │
│           │                       │            │   举报集合      │ │
│           │                       │            │  (Reports)      │ │
│           │                       │            ├─────────────────┤ │
│           │                       │            │ • _id           │ │
│           │                       │            │ • reporter      │ │
│           │                       │            │ • targetType    │ │
│           │                       │            │ • targetId      │ │
│           │                       │            │ • reason        │ │
│           │                       │            │ • status        │ │
│           │                       │            │ • createdAt     │ │
│           │                       │            └─────────────────┘ │
│           └───────────────────────┼─────────────────────────────┘ │
│                                   │                                 │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                   索引设计 (Indexes)                            │ │
│  ├─────────────────────────────────────────────────────────────────┤ │
│  │ • Users: username (unique), email (unique), phone (unique)     │ │
│  │ • Products: seller, category, status, createdAt               │ │
│  │ • Chats: participants, createdAt                              │ │
│  │ • Messages: chatId, sender, createdAt                         │ │
│  │ • Ratings: productId, reviewer                                │ │
│  │ • Reports: targetType, targetId, status                       │ │
│  └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 数据流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                       数据流程图 (Data Flow)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  用户操作流程:                                                   │
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │   用户输入   │───▶│   前端验证   │───▶│   API请求   │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                              │                    │             │
│                              ▼                    ▼             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │   错误提示   │◀───│   后端验证   │◀───│   中间件    │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                              │                    │             │
│                              ▼                    ▼             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │   成功响应   │◀───│   业务逻辑   │◀───│   数据库    │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                 │
│  商品发布流程:                                                   │
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │   表单提交   │───▶│   AI审核    │───▶│   文件上传   │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                              │                    │             │
│                              ▼                    ▼             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │   价格估算   │◀───│   数据保存   │◀───│   图片处理   │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                 │
│  聊天消息流程:                                                   │
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │   发送消息   │───▶│   实时存储   │───▶│   推送通知   │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                              │                    │             │
│                              ▼                    ▼             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │   消息历史   │◀───│   状态更新   │◀───│   接收确认   │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

## 🚀 部署架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                       部署架构 (Deployment Architecture)          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                        生产环境 (Production)                     │ │
│  ├─────────────────────────────────────────────────────────────────┤ │
│  │                                                                 │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │ │
│  │  │   前端部署      │    │   后端部署      │    │   数据库        │ │ │
│  │  │  (Frontend)     │    │  (Backend)      │    │  (Database)     │ │ │
│  │  ├─────────────────┤    ├─────────────────┤    ├─────────────────┤ │ │
│  │  │ • Railway       │    │ • Railway       │    │ • MongoDB Atlas │ │ │
│  │  │ • Vite Build    │    │ • Node.js       │    │ • 云存储        │ │ │
│  │  │ • Static Files  │    │ • Express.js    │    │ • 自动备份      │ │ │
│  │  │ • CDN           │    │ • PM2           │    │ • 监控告警      │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────┘ │ │
│  │           │                       │                       │         │ │
│  │           └───────────────────────┼───────────────────────┘         │ │
│  │                                   │                                 │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │                   外部服务集成 (External Services)               │ │ │
│  │  ├─────────────────────────────────────────────────────────────────┤ │ │
│  │  │ • OpenAI API (内容审核)                                        │ │ │
│  │  │ • Hugging Face API (AI服务)                                   │ │ │
│  │  │ • SMS Gateway (短信服务)                                      │ │ │
│  │  │ • Email Service (邮件服务)                                    │ │ │
│  │  │ • Payment Gateway (支付服务)                                  │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                   │                                 │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                        开发环境 (Development)                    │ │
│  ├─────────────────────────────────────────────────────────────────┤ │
│  │                                                                 │ │
│  │  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │ │
│  │  │   本地开发      │    │   版本控制      │    │   测试环境      │ │ │
│  │  │  (Local Dev)    │    │  (Git)          │    │  (Testing)      │ │ │
│  │  ├─────────────────┤    ├─────────────────┤    ├─────────────────┤ │ │
│  │  │ • Vite Dev      │    │ • GitHub        │    │ • Jest          │ │ │
│  │  │ • Hot Reload    │    │ • Branching     │    │ • Supertest     │ │ │
│  │  │ • Debug Tools   │    │ • CI/CD         │    │ • Mock Data     │ │ │
│  │  │ • ESLint        │    │ • Auto Deploy   │    │ • E2E Testing   │ │ │
│  │  └─────────────────┘    └─────────────────┘    └─────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                        监控运维 (Monitoring & Ops)               │ │
│  ├─────────────────────────────────────────────────────────────────┤ │
│  │ • 应用性能监控 (APM)                                            │ │
│  │ • 错误日志收集 (Error Logging)                                  │ │
│  │ • 用户行为分析 (Analytics)                                      │ │
│  │ • 服务器监控 (Server Monitoring)                                │ │
│  │ • 数据库性能监控 (DB Monitoring)                                │ │
│  └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 📊 技术栈总结

### 前端技术栈
- **框架**: React 18 + TypeScript
- **构建工具**: Vite
- **UI组件库**: Antd Mobile
- **样式**: CSS Modules + Emotion Styled
- **状态管理**: React Hooks
- **路由**: React Router v6
- **HTTP客户端**: Axios
- **部署**: Railway

### 后端技术栈
- **运行时**: Node.js
- **框架**: Express.js
- **数据库**: MongoDB + Mongoose
- **认证**: JWT + bcrypt
- **文件上传**: Multer
- **AI集成**: OpenAI API + Hugging Face
- **部署**: Railway

### 数据库设计
- **主数据库**: MongoDB Atlas
- **集合**: Users, Products, Chats, Messages, Ratings, Reports
- **索引**: 用户名、邮箱、手机号唯一索引
- **备份**: 自动备份 + 手动备份

### 外部服务
- **AI服务**: OpenAI (内容审核), Hugging Face (价格估算)
- **通信服务**: SMS Gateway (短信验证)
- **存储服务**: 云存储 (图片文件)
- **监控服务**: 应用性能监控

### 安全措施
- **认证**: JWT Token + 密码加密
- **授权**: 基于角色的访问控制
- **数据验证**: 前后端双重验证
- **内容审核**: AI自动审核
- **HTTPS**: 全站SSL加密

这个架构设计确保了系统的可扩展性、可维护性和安全性，适合从MVP快速迭代到商业化产品。
